name: Build and Release

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
      - master
      - develop
  workflow_dispatch:
  pull_request:
    branches:
      - main
      - master

jobs:
  build-windows-x64:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Download FFmpeg for Windows
        run: |
          python tools/download_ffmpeg.py
      
      - name: Build executable
        run: |
          python scripts/build_complete.py
      
      - name: Find executable
        shell: pwsh
        id: find_exe
        run: |
          $exe = Get-ChildItem -Path "dist" -Filter "MKVProcessor.exe" | Select-Object -First 1
          if (-not $exe) {
            throw "Không tìm thấy MKVProcessor.exe trong thư mục dist/"
          }
          $sizeMB = [math]::Round($exe.Length / 1MB, 2)
          Write-Host "Found: $($exe.FullName)"
          Write-Host "Size: $sizeMB MB"
          echo "exe_path=$($exe.FullName)" >> $env:GITHUB_OUTPUT
          echo "exe_name=$($exe.Name)" >> $env:GITHUB_OUTPUT
          echo "size_mb=$sizeMB" >> $env:GITHUB_OUTPUT
      
      - name: Upload executable
        uses: actions/upload-artifact@v4
        with:
          name: MKVProcessor-Windows-x64
          path: ${{ steps.find_exe.outputs.exe_path }}

  build-windows-x86:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Download FFmpeg for Windows (x86)
        run: |
          $url = "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip"
          Invoke-WebRequest -Uri $url -OutFile "ffmpeg_temp.zip"
          Expand-Archive -Path "ffmpeg_temp.zip" -DestinationPath "." -Force
          $ffmpegDir = Get-ChildItem -Directory | Where-Object { $_.Name -like "ffmpeg-*" } | Select-Object -First 1
          if (-not $ffmpegDir) { throw "Không tìm thấy thư mục ffmpeg sau khi giải nén." }
          New-Item -ItemType Directory -Path "ffmpeg_bin" -Force | Out-Null
          Copy-Item "$($ffmpegDir.FullName)\bin\*.exe" -Destination "ffmpeg_bin" -Force
          Remove-Item "ffmpeg_temp.zip"
          Remove-Item $ffmpegDir -Recurse -Force
      
      - name: Build executable
        run: |
          python scripts/build_complete.py
      
      - name: Find executable (x86)
        shell: pwsh
        id: find_exe_x86
        run: |
          $exe = Get-ChildItem -Path "dist" -Filter "MKVProcessor.exe" | Select-Object -First 1
          if (-not $exe) {
            throw "Không tìm thấy MKVProcessor.exe trong thư mục dist/"
          }
          $sizeMB = [math]::Round($exe.Length / 1MB, 2)
          Write-Host "Found: $($exe.FullName)"
          Write-Host "Size: $sizeMB MB"
          echo "exe_path=$($exe.FullName)" >> $env:GITHUB_OUTPUT
          echo "exe_name=$($exe.Name)" >> $env:GITHUB_OUTPUT
          echo "size_mb=$sizeMB" >> $env:GITHUB_OUTPUT
      
      - name: Upload executable (x86)
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: MKVProcessor-Windows-x86
          path: ${{ steps.find_exe_x86.outputs.exe_path }}
          if-no-files-found: ignore

  build-macos-x64:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install FFmpeg
        run: |
          brew install ffmpeg
          mkdir -p ffmpeg_bin
          cp $(which ffmpeg) ffmpeg_bin/
          cp $(which ffprobe) ffmpeg_bin/
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Build executable
        run: |
          python scripts/build_complete.py
      
      - name: Create ZIP archive
        run: |
          set -euo pipefail
          cd dist
          target=$(ls -1dt MKVProcessor* 2>/dev/null | head -n 1 || true)
          if [ -z "$target" ]; then
            echo "Không tìm thấy output trong dist/" >&2
            exit 1
          fi
          zip -r ../MKVProcessor_macOS_x64.zip "$target"
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: MKVProcessor-macOS-x64
          path: MKVProcessor_macOS_x64.zip

  build-macos-arm64:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install FFmpeg
        run: |
          brew install ffmpeg
          mkdir -p ffmpeg_bin
          cp $(which ffmpeg) ffmpeg_bin/
          cp $(which ffprobe) ffmpeg_bin/
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Build executable
        run: |
          python scripts/build_complete.py
      
      - name: Create ZIP archive
        run: |
          set -euo pipefail
          cd dist
          target=$(ls -1dt MKVProcessor* 2>/dev/null | head -n 1 || true)
          if [ -z "$target" ]; then
            echo "Không tìm thấy output trong dist/" >&2
            exit 1
          fi
          zip -r ../MKVProcessor_macOS_arm64.zip "$target"
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: MKVProcessor-macOS-arm64
          path: MKVProcessor_macOS_arm64.zip

  build-linux-x64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          mkdir -p ffmpeg_bin
          cp $(which ffmpeg) ffmpeg_bin/
          cp $(which ffprobe) ffmpeg_bin/
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Build executable
        run: |
          python scripts/build_complete.py
      
      - name: Create TAR.GZ archive
        run: |
          set -euo pipefail
          cd dist
          target=$(ls -1dt MKVProcessor* 2>/dev/null | head -n 1 || true)
          if [ -z "$target" ]; then
            echo "Không tìm thấy output trong dist/" >&2
            exit 1
          fi
          tar -czf ../MKVProcessor_Linux_x64.tar.gz "$target"
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: MKVProcessor-Linux-x64
          path: MKVProcessor_Linux_x64.tar.gz

  build-linux-arm64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          mkdir -p ffmpeg_bin
          cp $(which ffmpeg) ffmpeg_bin/
          cp $(which ffprobe) ffmpeg_bin/
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Build executable
        run: |
          python scripts/build_complete.py
      
      - name: Create TAR.GZ archive
        run: |
          set -euo pipefail
          cd dist
          target=$(ls -1dt MKVProcessor* 2>/dev/null | head -n 1 || true)
          if [ -z "$target" ]; then
            echo "Không tìm thấy output trong dist/" >&2
            exit 1
          fi
          tar -czf ../MKVProcessor_Linux_arm64.tar.gz "$target"
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: MKVProcessor-Linux-arm64
          path: MKVProcessor_Linux_arm64.tar.gz

  release:
    needs: [build-windows-x64, build-windows-x86, build-macos-x64, build-macos-arm64, build-linux-x64, build-linux-arm64]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    # Tự động tạo release cho mọi push/workflow_dispatch (trừ pull_request)
    if: github.event_name != 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog from commit history
        run: |
          {
            echo "## Changelog ($(date -u +"%Y-%m-%d %H:%M:%S") UTC)"
            echo
            git log -n 50 --pretty=format:"- %s (%h)"
          } > release_notes.md
          if [ ! -s release_notes.md ]; then
            echo "- No commits found." > release_notes.md
          fi

      - name: Set release metadata
        id: release_meta
        run: |
          DATE_SEG=$(date -u +%m.%d)
          YEAR=$(date -u +%Y)
          YEAR_SEG=$((YEAR - 2024))
          BUILD_SEG=${GITHUB_RUN_NUMBER}
          if [[ "${GITHUB_REF}" == "refs/heads/main" || "${GITHUB_REF}" == "refs/heads/master" ]]; then
            VERSION="${YEAR_SEG}.${DATE_SEG}.${BUILD_SEG}"
            PRERELEASE=false
            NAME="Release ${VERSION}"
          else
            VERSION="${YEAR_SEG}.${DATE_SEG}.beta-${BUILD_SEG}"
            PRERELEASE=true
            NAME="Beta ${VERSION}"
          fi
          {
            echo "version=${VERSION}"
            echo "tag=${VERSION}"
            echo "name=${NAME}"
            echo "prerelease=${PRERELEASE}"
          } >> "$GITHUB_OUTPUT"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          merge-multiple: false
          path: artifacts
      
      - name: Prepare release files
        shell: bash
        run: |
          # Windows x64
          if [ -f "artifacts/MKVProcessor-Windows-x64/MKVProcessor.exe" ]; then
            cp "artifacts/MKVProcessor-Windows-x64/MKVProcessor.exe" "MKVProcessor_Windows_x64.exe"
          fi
          # Windows x86
          if [ -f "artifacts/MKVProcessor-Windows-x86/MKVProcessor.exe" ]; then
            cp "artifacts/MKVProcessor-Windows-x86/MKVProcessor.exe" "MKVProcessor_Windows_x86.exe"
          fi
          # macOS x64
          if [ -d "artifacts/MKVProcessor-macOS-x64/MKVProcessor.app" ]; then
            zip -r "MKVProcessor_macOS_x64.zip" "artifacts/MKVProcessor-macOS-x64/MKVProcessor.app"
          fi
          # macOS arm64
          if [ -d "artifacts/MKVProcessor-macOS-arm64/MKVProcessor.app" ]; then
            zip -r "MKVProcessor_macOS_arm64.zip" "artifacts/MKVProcessor-macOS-arm64/MKVProcessor.app"
          fi
          # Linux x64
          if [ -f "artifacts/MKVProcessor-Linux-x64/MKVProcessor" ]; then
            cp "artifacts/MKVProcessor-Linux-x64/MKVProcessor" "MKVProcessor_Linux_x64"
            chmod +x "MKVProcessor_Linux_x64"
          fi
          # Linux arm64
          if [ -f "artifacts/MKVProcessor-Linux-arm64/MKVProcessor" ]; then
            cp "artifacts/MKVProcessor-Linux-arm64/MKVProcessor" "MKVProcessor_Linux_arm64"
            chmod +x "MKVProcessor_Linux_arm64"
          fi
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release_meta.outputs.tag }}
          target_commitish: ${{ github.sha }}
          name: ${{ steps.release_meta.outputs.name }}
          body_path: release_notes.md
          prerelease: ${{ steps.release_meta.outputs.prerelease }}
          files: |
            MKVProcessor_Windows_x64.exe
            MKVProcessor_Windows_x86.exe
            MKVProcessor_macOS_x64.zip
            MKVProcessor_macOS_arm64.zip
            MKVProcessor_Linux_x64
            MKVProcessor_Linux_arm64
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

