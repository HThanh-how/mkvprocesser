name: Build and Release

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
      - master
      - develop
  workflow_dispatch:
  pull_request:
    branches:
      - main
      - master
      - develop

jobs:
  build-windows-x64:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Download FFmpeg for Windows
        run: |
          python tools/download_ffmpeg.py
      
      - name: Build executable
        run: |
          python scripts/build_complete.py
      
      - name: Find executable
        shell: pwsh
        id: find_exe
        run: |
          $exe = Get-ChildItem -Path "dist" -Filter "MKVProcessor.exe" | Select-Object -First 1
          if (-not $exe) {
            throw "Không tìm thấy MKVProcessor.exe trong thư mục dist/"
          }
          $sizeMB = [math]::Round($exe.Length / 1MB, 2)
          Write-Host "Found: $($exe.FullName)"
          Write-Host "Size: $sizeMB MB"
          echo "exe_path=$($exe.FullName)" >> $env:GITHUB_OUTPUT
          echo "exe_name=$($exe.Name)" >> $env:GITHUB_OUTPUT
          echo "size_mb=$sizeMB" >> $env:GITHUB_OUTPUT
      
      - name: Upload executable
        uses: actions/upload-artifact@v4
        with:
          name: MKVProcessor-Windows-x64
          path: ${{ steps.find_exe.outputs.exe_path }}

  build-windows-x86:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Download FFmpeg for Windows (x86)
        run: |
          $url = "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip"
          Invoke-WebRequest -Uri $url -OutFile "ffmpeg_temp.zip"
          Expand-Archive -Path "ffmpeg_temp.zip" -DestinationPath "." -Force
          $ffmpegDir = Get-ChildItem -Directory | Where-Object { $_.Name -like "ffmpeg-*" } | Select-Object -First 1
          if (-not $ffmpegDir) { throw "Không tìm thấy thư mục ffmpeg sau khi giải nén." }
          New-Item -ItemType Directory -Path "ffmpeg_bin" -Force | Out-Null
          Copy-Item "$($ffmpegDir.FullName)\bin\*.exe" -Destination "ffmpeg_bin" -Force
          Remove-Item "ffmpeg_temp.zip"
          Remove-Item $ffmpegDir -Recurse -Force
      
      - name: Build executable
        run: |
          python scripts/build_complete.py
      
      - name: Find executable (x86)
        shell: pwsh
        id: find_exe_x86
        run: |
          $exe = Get-ChildItem -Path "dist" -Filter "MKVProcessor.exe" | Select-Object -First 1
          if (-not $exe) {
            throw "Không tìm thấy MKVProcessor.exe trong thư mục dist/"
          }
          $sizeMB = [math]::Round($exe.Length / 1MB, 2)
          Write-Host "Found: $($exe.FullName)"
          Write-Host "Size: $sizeMB MB"
          echo "exe_path=$($exe.FullName)" >> $env:GITHUB_OUTPUT
          echo "exe_name=$($exe.Name)" >> $env:GITHUB_OUTPUT
          echo "size_mb=$sizeMB" >> $env:GITHUB_OUTPUT
      
      - name: Upload executable (x86)
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: MKVProcessor-Windows-x86
          path: ${{ steps.find_exe_x86.outputs.exe_path }}
          if-no-files-found: ignore

  build-macos-x64:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install FFmpeg
        run: |
          brew install ffmpeg
          mkdir -p ffmpeg_bin
          cp $(which ffmpeg) ffmpeg_bin/
          cp $(which ffprobe) ffmpeg_bin/
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Build executable
        run: |
          python scripts/build_complete.py
      
      - name: Create ZIP archive
        run: |
          set -euo pipefail
          cd dist
          target=$(ls -1dt MKVProcessor* 2>/dev/null | head -n 1 || true)
          if [ -z "$target" ]; then
            echo "Không tìm thấy output trong dist/" >&2
            exit 1
          fi
          zip -r ../MKVProcessor_macOS_x64.zip "$target"
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: MKVProcessor-macOS-x64
          path: MKVProcessor_macOS_x64.zip

  build-macos-arm64:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install FFmpeg
        run: |
          brew install ffmpeg
          mkdir -p ffmpeg_bin
          cp $(which ffmpeg) ffmpeg_bin/
          cp $(which ffprobe) ffmpeg_bin/
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Build executable
        run: |
          python scripts/build_complete.py
      
      - name: Create ZIP archive
        run: |
          set -euo pipefail
          cd dist
          target=$(ls -1dt MKVProcessor* 2>/dev/null | head -n 1 || true)
          if [ -z "$target" ]; then
            echo "Không tìm thấy output trong dist/" >&2
            exit 1
          fi
          zip -r ../MKVProcessor_macOS_arm64.zip "$target"
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: MKVProcessor-macOS-arm64
          path: MKVProcessor_macOS_arm64.zip

  build-linux-x64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          mkdir -p ffmpeg_bin
          cp $(which ffmpeg) ffmpeg_bin/
          cp $(which ffprobe) ffmpeg_bin/
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Build executable
        run: |
          python scripts/build_complete.py
      
      - name: Create TAR.GZ archive
        run: |
          set -euo pipefail
          cd dist
          target=$(ls -1dt MKVProcessor* 2>/dev/null | head -n 1 || true)
          if [ -z "$target" ]; then
            echo "Không tìm thấy output trong dist/" >&2
            exit 1
          fi
          tar -czf ../MKVProcessor_Linux_x64.tar.gz "$target"
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: MKVProcessor-Linux-x64
          path: MKVProcessor_Linux_x64.tar.gz

  build-linux-arm64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          mkdir -p ffmpeg_bin
          cp $(which ffmpeg) ffmpeg_bin/
          cp $(which ffprobe) ffmpeg_bin/
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Build executable
        run: |
          python scripts/build_complete.py
      
      - name: Create TAR.GZ archive
        run: |
          set -euo pipefail
          cd dist
          target=$(ls -1dt MKVProcessor* 2>/dev/null | head -n 1 || true)
          if [ -z "$target" ]; then
            echo "Không tìm thấy output trong dist/" >&2
            exit 1
          fi
          tar -czf ../MKVProcessor_Linux_arm64.tar.gz "$target"
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: MKVProcessor-Linux-arm64
          path: MKVProcessor_Linux_arm64.tar.gz

  release:
    needs: [build-windows-x64, build-windows-x86, build-macos-x64, build-macos-arm64, build-linux-x64, build-linux-arm64]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    # Chỉ tạo release cho push/workflow_dispatch (không tạo cho pull_request)
    # Và chỉ cho 3 nhánh: main, master, develop
    if: >
      github.event_name != 'pull_request' &&
      (github.ref == 'refs/heads/main' ||
       github.ref == 'refs/heads/master' ||
       github.ref == 'refs/heads/develop')
    continue-on-error: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog from commit history
        run: |
          echo "## Changelog ($(date -u +"%Y-%m-%d %H:%M:%S") UTC)" > release_notes.md
          echo "" >> release_notes.md
          
          # Xác định loại release dựa trên branch
          if [[ "${GITHUB_REF}" == "refs/heads/develop" ]]; then
            # Beta release: tìm beta tag gần nhất (có "beta" trong tên)
            LATEST_TAG=$(git tag --sort=-creatordate | grep "beta" | head -n 1 || echo "")
            RELEASE_TYPE="beta"
          elif [[ "${GITHUB_REF}" == "refs/heads/main" || "${GITHUB_REF}" == "refs/heads/master" ]]; then
            # Stable release: tìm stable tag gần nhất (không có "beta")
            LATEST_TAG=$(git tag --sort=-creatordate | grep -v "beta" | head -n 1 || echo "")
            RELEASE_TYPE="stable"
          else
            # Fallback: tìm bất kỳ tag nào gần nhất
            LATEST_TAG=$(git tag --sort=-creatordate | head -n 1 || echo "")
            RELEASE_TYPE="unknown"
          fi
          
          if [ -n "$LATEST_TAG" ]; then
            git log "${LATEST_TAG}..HEAD" --pretty=format:"- %s (%h)" >> release_notes.md 2>/dev/null || {
              echo "- Không có commits mới từ $LATEST_TAG" >> release_notes.md
            }
          else
            git log -n 50 --pretty=format:"- %s (%h)" >> release_notes.md
          fi
          
          if [ ! -s release_notes.md ] || [ "$(wc -l < release_notes.md)" -lt 3 ]; then
            echo "- No commits found." > release_notes.md
          fi

      - name: Set release metadata
        id: release_meta
        run: |
          DATE_SEG=$(date -u +%m.%d)
          YEAR=$(date -u +%Y)
          YEAR_SEG=$((YEAR - 2024))
          BUILD_SEG=${GITHUB_RUN_NUMBER}
          if [[ "${GITHUB_REF}" == "refs/heads/main" || "${GITHUB_REF}" == "refs/heads/master" ]]; then
            # Stable release cho main/master
            VERSION="${YEAR_SEG}.${DATE_SEG}.${BUILD_SEG}"
            PRERELEASE=false
            NAME="Release ${VERSION}"
          elif [[ "${GITHUB_REF}" == "refs/heads/develop" ]]; then
            # Beta prerelease cho develop
            VERSION="${YEAR_SEG}.${DATE_SEG}.beta-${BUILD_SEG}"
            PRERELEASE=true
            NAME="Beta ${VERSION}"
          else
            echo "Unsupported ref for release: ${GITHUB_REF}"
            exit 1
          fi
          {
            echo "version=${VERSION}"
            echo "tag=${VERSION}"
            echo "name=${NAME}"
            echo "prerelease=${PRERELEASE}"
          } >> "$GITHUB_OUTPUT"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          merge-multiple: false
          path: artifacts
      
      - name: Debug artifacts structure
        shell: bash
        run: |
          echo "=== Artifacts structure ==="
          find artifacts -type f -o -type d | head -20
          echo "=== Listing artifacts directory ==="
          ls -la artifacts/ || echo "artifacts/ not found"
          echo "=== Checking each artifact ==="
          for dir in artifacts/*/; do
            echo "Directory: $dir"
            ls -la "$dir" || echo "  (empty or not found)"
          done
      
      - name: Prepare release files
        shell: bash
        run: |
          set -e
          echo "=== Preparing release files ==="
          
          # Windows x64 - artifact name: MKVProcessor-Windows-x64
          if [ -f "artifacts/MKVProcessor-Windows-x64/MKVProcessor.exe" ]; then
            cp "artifacts/MKVProcessor-Windows-x64/MKVProcessor.exe" "MKVProcessor_Windows_x64.exe"
            echo "✅ Windows x64: OK"
          else
            echo "⚠️ Windows x64: Not found at artifacts/MKVProcessor-Windows-x64/MKVProcessor.exe"
            ls -la "artifacts/MKVProcessor-Windows-x64/" || echo "  Directory not found"
          fi
          
          # Windows x86 - artifact name: MKVProcessor-Windows-x86
          if [ -f "artifacts/MKVProcessor-Windows-x86/MKVProcessor.exe" ]; then
            cp "artifacts/MKVProcessor-Windows-x86/MKVProcessor.exe" "MKVProcessor_Windows_x86.exe"
            echo "✅ Windows x86: OK"
          else
            echo "⚠️ Windows x86: Not found (optional, may not exist)"
          fi
          
          # macOS x64 - artifact là ZIP file đã được upload
          if [ -f "artifacts/MKVProcessor-macOS-x64/MKVProcessor_macOS_x64.zip" ]; then
            cp "artifacts/MKVProcessor-macOS-x64/MKVProcessor_macOS_x64.zip" "MKVProcessor_macOS_x64.zip"
            echo "✅ macOS x64: OK (from ZIP)"
          elif [ -d "artifacts/MKVProcessor-macOS-x64" ]; then
            # Tìm .app hoặc file bất kỳ trong thư mục
            cd "artifacts/MKVProcessor-macOS-x64"
            if [ -d "MKVProcessor.app" ]; then
              zip -r "../../MKVProcessor_macOS_x64.zip" "MKVProcessor.app"
              echo "✅ macOS x64: OK (created ZIP from .app)"
            else
              # Nếu không có .app, zip toàn bộ thư mục
              zip -r "../../MKVProcessor_macOS_x64.zip" .
              echo "✅ macOS x64: OK (created ZIP from directory)"
            fi
            cd ../..
          else
            echo "⚠️ macOS x64: Not found"
            ls -la "artifacts/" || echo "  artifacts/ not found"
          fi
          
          # macOS arm64 - artifact là ZIP file đã được upload
          if [ -f "artifacts/MKVProcessor-macOS-arm64/MKVProcessor_macOS_arm64.zip" ]; then
            cp "artifacts/MKVProcessor-macOS-arm64/MKVProcessor_macOS_arm64.zip" "MKVProcessor_macOS_arm64.zip"
            echo "✅ macOS arm64: OK (from ZIP)"
          elif [ -d "artifacts/MKVProcessor-macOS-arm64" ]; then
            cd "artifacts/MKVProcessor-macOS-arm64"
            if [ -d "MKVProcessor.app" ]; then
              zip -r "../../MKVProcessor_macOS_arm64.zip" "MKVProcessor.app"
              echo "✅ macOS arm64: OK (created ZIP from .app)"
            else
              zip -r "../../MKVProcessor_macOS_arm64.zip" .
              echo "✅ macOS arm64: OK (created ZIP from directory)"
            fi
            cd ../..
          else
            echo "⚠️ macOS arm64: Not found"
            ls -la "artifacts/" || echo "  artifacts/ not found"
          fi
          
          # Linux x64 - artifact là TAR.GZ file đã được upload
          if [ -f "artifacts/MKVProcessor-Linux-x64/MKVProcessor_Linux_x64.tar.gz" ]; then
            cp "artifacts/MKVProcessor-Linux-x64/MKVProcessor_Linux_x64.tar.gz" "MKVProcessor_Linux_x64.tar.gz"
            tar -xzf "MKVProcessor_Linux_x64.tar.gz" -C . 2>/dev/null || true
            # Tìm file executable sau khi extract
            if [ -f "MKVProcessor" ]; then
              mv "MKVProcessor" "MKVProcessor_Linux_x64"
              chmod +x "MKVProcessor_Linux_x64"
            elif [ -f "dist/MKVProcessor" ]; then
              cp "dist/MKVProcessor" "MKVProcessor_Linux_x64"
              chmod +x "MKVProcessor_Linux_x64"
            fi
            echo "✅ Linux x64: OK (from TAR.GZ)"
          elif [ -f "artifacts/MKVProcessor-Linux-x64/MKVProcessor" ]; then
            cp "artifacts/MKVProcessor-Linux-x64/MKVProcessor" "MKVProcessor_Linux_x64"
            chmod +x "MKVProcessor_Linux_x64"
            echo "✅ Linux x64: OK (from binary)"
          else
            echo "⚠️ Linux x64: Not found"
            ls -la "artifacts/MKVProcessor-Linux-x64/" || echo "  Directory not found"
          fi
          
          # Linux arm64 - artifact là TAR.GZ file đã được upload
          if [ -f "artifacts/MKVProcessor-Linux-arm64/MKVProcessor_Linux_arm64.tar.gz" ]; then
            cp "artifacts/MKVProcessor-Linux-arm64/MKVProcessor_Linux_arm64.tar.gz" "MKVProcessor_Linux_arm64.tar.gz"
            tar -xzf "MKVProcessor_Linux_arm64.tar.gz" -C . 2>/dev/null || true
            if [ -f "MKVProcessor" ]; then
              mv "MKVProcessor" "MKVProcessor_Linux_arm64"
              chmod +x "MKVProcessor_Linux_arm64"
            elif [ -f "dist/MKVProcessor" ]; then
              cp "dist/MKVProcessor" "MKVProcessor_Linux_arm64"
              chmod +x "MKVProcessor_Linux_arm64"
            fi
            echo "✅ Linux arm64: OK (from TAR.GZ)"
          elif [ -f "artifacts/MKVProcessor-Linux-arm64/MKVProcessor" ]; then
            cp "artifacts/MKVProcessor-Linux-arm64/MKVProcessor" "MKVProcessor_Linux_arm64"
            chmod +x "MKVProcessor_Linux_arm64"
            echo "✅ Linux arm64: OK (from binary)"
          else
            echo "⚠️ Linux arm64: Not found"
            ls -la "artifacts/MKVProcessor-Linux-arm64/" || echo "  Directory not found"
          fi
          
          echo ""
          echo "=== Final files ready for release ==="
          ls -lh MKVProcessor_* || echo "No files found"
      
      - name: List files before release
        shell: bash
        run: |
          echo "=== Files ready for release ==="
          ls -lh MKVProcessor_* 2>/dev/null || echo "No files found"
          echo ""
          echo "=== File sizes ==="
          for f in MKVProcessor_*; do
            if [ -f "$f" ]; then
              size=$(du -h "$f" | cut -f1)
              echo "$f: $size"
            fi
          done
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release_meta.outputs.tag }}
          target_commitish: ${{ github.sha }}
          name: ${{ steps.release_meta.outputs.name }}
          body_path: release_notes.md
          prerelease: ${{ steps.release_meta.outputs.prerelease }}
          draft: false
          files: |
            MKVProcessor_Windows_x64.exe
            MKVProcessor_Windows_x86.exe
            MKVProcessor_macOS_x64.zip
            MKVProcessor_macOS_arm64.zip
            MKVProcessor_Linux_x64
            MKVProcessor_Linux_arm64
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

